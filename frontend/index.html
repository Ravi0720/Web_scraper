<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crime Data Visualizer</title>
    <script src="https://cdn.jsdelivr.net/npm/react@17.0.2/umd/react.development.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/react-dom@17.0.2/umd/react-dom.development.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/babel-standalone@6.26.0/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-900 text-white">
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect } = React;

        const App = () => {
            const [data, setData] = useState([]);
            const [status, setStatus] = useState('');
            const [name, setName] = useState('');
            const [image, setImage] = useState(null);
            const [identifications, setIdentifications] = useState([]);
            const [lat, setLat] = useState('37.7749');
            const [lon, setLon] = useState('-122.4194');
            const [startDate, setStartDate] = useState('2025-04-01T00:00:00');
            const [endDate, setEndDate] = useState('2025-04-25T23:59:59');
            const [crimeometerData, setCrimeometerData] = useState(null);

            const fetchData = async () => {
                try {
                    const response = await fetch('http://localhost:8000/data');
                    if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
                    const result = await response.json();
                    setData(result);
                } catch (error) {
                    console.error('Error fetching data:', error.message);
                    setStatus(`Error fetching data: ${error.message}`);
                }
            };

            const handleFetchData = async () => {
                try {
                    const response = await fetch('http://localhost:8000/fetch-data', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({})
                    });
                    if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
                    const result = await response.json();
                    setStatus(result.status);
                    fetchData();
                } catch (error) {
                    console.error('Error fetching data:', error.message);
                    setStatus(`Error fetching data: ${error.message}`);
                }
            };

            const handleFetchCrimeometer = async () => {
                try {
                    const response = await fetch('http://localhost:8000/fetch-crimeometer', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            lat: parseFloat(lat),
                            lon: parseFloat(lon),
                            start_date: startDate,
                            end_date: endDate,
                            distance: "1mi"
                        })
                    });
                    if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
                    const result = await response.json();
                    setCrimeometerData(result.data);
                    fetchData();
                } catch (error) {
                    console.error('Error fetching CrimeoMeter data:', error.message);
                    setStatus(`Error fetching CrimeoMeter data: ${error.message}`);
                }
            };

            const handleIdentifyImage = async (e) => {
                e.preventDefault();
                if (!image) {
                    setIdentifications([{ name: "Error", details: "No image uploaded" }]);
                    return;
                }
                const formData = new FormData();
                formData.append('image', image);
                try {
                    const response = await fetch('http://localhost:8000/identify/image', {
                        method: 'POST',
                        body: formData
                    });
                    if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
                    const result = await response.json();
                    setIdentifications(result.identifications);
                } catch (error) {
                    console.error('Error identifying image:', error.message);
                    setIdentifications([{ name: "Error", details: error.message }]);
                }
            };

            const handleIdentifyName = async () => {
                if (!name) {
                    setIdentifications([{ name: "Error", "details": "No name entered" }]);
                    return;
                }
                try {
                    const response = await fetch('http://localhost:8000/identify/name', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ name })
                    });
                    if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
                    const result = await response.json();
                    setIdentifications([result.identification]);
                } catch (error) {
                    console.error('Error identifying name:', error.message);
                    setIdentifications([{ name: "Error", "details": error.message }]);
                }
            };

            useEffect(() => {
                const scene = new THREE.Scene();
                const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
                const renderer = new THREE.WebGLRenderer();
                renderer.setSize(window.innerWidth, window.innerHeight);
                document.getElementById('three-canvas').appendChild(renderer.domElement);

                const controls = new THREE.OrbitControls(camera, renderer.domElement);
                controls.enableDamping = true;
                controls.dampingFactor = 0.25;
                controls.screenSpacePanning = false;

                const ambientLight = new THREE.AmbientLight(0x404040);
                scene.add(ambientLight);
                const pointLight = new THREE.PointLight(0xffffff, 1, 100);
                pointLight.position.set(10, 10, 10);
                scene.add(pointLight);

                const crimeTypes = data.length > 0 ? [...new Set(data.map(d => d.crime_story.match(/murder|theft|assault|robbery|arrest/i)?.[0] || 'Crime'))].slice(0, 5) : ['Robbery', 'Assault', 'Burglary', 'Theft', 'Vandalism'];
                const counts = crimeTypes.map(type => data.filter(d => d.crime_story.toLowerCase().includes(type.toLowerCase())).length || Math.random() * 10);

                const bars = [];
                crimeTypes.forEach((type, i) => {
                    const geometry = new THREE.BoxGeometry(0.8, counts[i], 0.8);
                    const material = new THREE.MeshPhongMaterial({ color: 0x00ff00 });
                    const bar = new THREE.Mesh(geometry, material);
                    bar.position.set(i * 1.5 - crimeTypes.length * 0.75, counts[i] / 2, 0);
                    scene.add(bar);
                    bars.push(bar);
                });

                camera.position.z = 15;

                const animate = () => {
                    requestAnimationFrame(animate);
                    bars.forEach(bar => {
                        bar.rotation.y += 0.01;
                    });
                    controls.update();
                    renderer.render(scene, camera);
                };
                animate();

                window.addEventListener('resize', () => {
                    camera.aspect = window.innerWidth / window.innerHeight;
                    camera.updateProjectionMatrix();
                    renderer.setSize(window.innerWidth, window.innerHeight);
                });

                return () => {
                    document.getElementById('three-canvas').innerHTML = '';
                };
            }, [data]);

            return (
                <div className="container mx-auto p-4">
                    <h1 className="text-4xl font-bold text-center mb-4">Crime Data Visualizer</h1>
                    <div className="mb-4">
                        <button
                            onClick={handleFetchData}
                            className="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded mr-2"
                        >
                            Fetch Crime Data from Reliable Sources
                        </button>
                        <p className="mt-2">{status}</p>
                    </div>

                    <div className="mt-4">
                        <h2 className="text-2xl font-bold">Fetch Real-Time Crime Data (CrimeoMeter)</h2>
                        <div className="mb-4">
                            <label className="block text-lg mb-2">Latitude:</label>
                            <input
                                type="text"
                                value={lat}
                                onChange={(e) => setLat(e.target.value)}
                                className="w-full p-2 bg-gray-800 text-white rounded"
                                placeholder="e.g., 37.7749 (San Francisco)"
                            />
                        </div>
                        <div className="mb-4">
                            <label className="block text-lg mb-2">Longitude:</label>
                            <input
                                type="text"
                                value={lon}
                                onChange={(e) => setLon(e.target.value)}
                                className="w-full p-2 bg-gray-800 text-white rounded"
                                placeholder="e.g., -122.4194 (San Francisco)"
                            />
                        </div>
                        <div className="mb-4">
                            <label className="block text-lg mb-2">Start Date (YYYY-MM-DDThh:mm:ss):</label>
                            <input
                                type="text"
                                value={startDate}
                                onChange={(e) => setStartDate(e.target.value)}
                                className="w-full p-2 bg-gray-800 text-white rounded"
                                placeholder="e.g., 2025-04-01T00:00:00"
                            />
                        </div>
                        <div className="mb-4">
                            <label className="block text-lg mb-2">End Date (YYYY-MM-DDThh:mm:ss):</label>
                            <input
                                type="text"
                                value={endDate}
                                onChange={(e) => setEndDate(e.target.value)}
                                className="w-full p-2 bg-gray-800 text-white rounded"
                                placeholder="e.g., 2025-04-25T23:59:59"
                            />
                        </div>
                        <button
                            onClick={handleFetchCrimeometer}
                            className="bg-purple-500 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded"
                        >
                            Fetch CrimeoMeter Data
                        </button>
                        {crimeometerData && (
                            <div className="bg-gray-800 p-4 rounded mt-2">
                                <h3 className="text-xl font-bold">CrimeoMeter Results</h3>
                                <pre>{JSON.stringify(crimeometerData, null, 2)}</pre>
                            </div>
                        )}
                    </div>

                    <div className="mt-4">
                        <h2 className="text-2xl font-bold">Identify Criminal</h2>
                        <div className="mb-4">
                            <label className="block text-lg mb-2">Upload Image:</label>
                            <input
                                type="file"
                                accept="image/*"
                                onChange={(e) => setImage(e.target.files[0])}
                                className="w-full p-2 bg-gray-800 text-white rounded"
                            />
                            <button
                                onClick={handleIdentifyImage}
                                className="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded mt-2"
                            >
                                Identify by Image
                            </button>
                        </div>
                        <div className="mb-4">
                            <label className="block text-lg mb-2">Enter Name:</label>
                            <input
                                type="text"
                                value={name}
                                onChange={(e) => setName(e.target.value)}
                                className="w-full p-2 bg-gray-800 text-white rounded"
                                placeholder="e.g., John Doe"
                            />
                            <button
                                onClick={handleIdentifyName}
                                className="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded mt-2"
                            >
                                Identify by Name
                            </button>
                        </div>
                        {identifications.length > 0 && (
                            <div className="bg-gray-800 p-4 rounded mt-2">
                                <h3 className="text-xl font-bold">Identification Results</h3>
                                {identifications.map((id, index) => (
                                    <div key={index} className="mt-2">
                                        <p><strong>Person {index + 1} Name:</strong> {id.name}</p>
                                        <p><strong>Details:</strong> {JSON.stringify(id.details)}</p>
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>

                    <div id="three-canvas" className="mt-4"></div>
                    <div className="mt-4">
                        <h2 className="text-2xl font-bold">Crime Data</h2>
                        {data.map((item, index) => (
                            <div key={index} className="bg-gray-800 p-4 rounded mt-2">
                                <p><strong>Source:</strong> {item.source}</p>
                                <p><strong>URL:</strong> {item.url}</p>
                                <p><strong>Criminal Name:</strong> {item.criminal_name}</p>
                                <p><strong>Crime Date:</strong> {item.crime_date}</p>
                                <p><strong>Crime Story:</strong> {item.crime_story}</p>
                                <p><strong>Fetched On:</strong> {item.fetch_date}</p>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>